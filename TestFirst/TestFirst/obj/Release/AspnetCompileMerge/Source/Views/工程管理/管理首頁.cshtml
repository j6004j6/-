@model IEnumerable<TestFirst.tMission>

@{
    ViewBag.Title = "FirstView";
    ViewBag.check = 0;


}

<br />
<!DOCTYPE html>
<html >




<head>
    @section styles
    {
        <style>
            body {
                
                margin-top: 20px;
            }
            p {               
                width:50%;
                float:left;
                font-family:標楷體;
                                    
            }
            td {
                font-size:14px;
                    
            }
            .mydiv {
                border: 2px solid #ADADAD;
                padding: 60px;
                border-radius: 20px;
            }
            
            
        </style>
        
    }
        
</head>

<body>
    @using (Html.BeginForm())
    {
        <div class="clearfix mydiv" id="search">
            <p>

                工程名稱
                <br />@Html.TextBox("txtName", "", new { htmlAttributes = new { @class = "form-control" } })

            </p>

            <p>
                工程階段@*@Html.TextBox("txtStage")*@
                <br />
                <select name="txtStage" id="selector" class="custom-select">
                    <option value=""></option>
                    @{
                        foreach (var item in ViewBag.stage)
                        {
                            <option value="@item">@item</option>
                        }
                    }
                </select>


            </p>
            <p>

                工程代號
                <br />  @Html.TextBox("txtCode")
            </p>
            @*<p>

                    距離完工天數
                    <br />@Html.TextBox("txtDaybefor")
                </p>*@

            <p>

                開工日期
                <br />@Html.TextBox("txtDayStart")-@Html.TextBox("txtDayEnd")
            </p>

            <p>
                工程負責人
                <br />@Html.TextBox("txtChargeMan")
            </p>

            <p>

                完工日期
                <br />@Html.TextBox("txtCompleteDayStart")-@Html.TextBox("txtCompleteDayEnd")
            </p>
            <p style="width:100%" >

                    工程金額
                    <br />@Html.TextBox("txtPaymentStart")-@Html.TextBox("txtPaymentEnd")
                </p>

            <p>
                <br />
                <input type="submit" value="查詢" class="btn btn-primary" />
            </p>
        </div>
    }
    <br />
    <br />


    <p style="width:250px">
        @Html.ActionLink("新增專案", "新增專案", "工程管理", null, new { @class = "btn btn-success", onclick = "return confirm('確認成立新專案??')" })

        @Html.ActionLink("日報列表", "日報列表", "工程管理", null, new { @class = "btn btn-success" })
        
    </p>


    <table class="table table-sm">
        <tr>
            <th>
                工程代碼
            </th>
            <th>
                工程名稱
            </th>

            <th>
                工程階段
            </th>      
            <th>
                開工日期
            </th>
            <th>
                工程日數
            </th>
            <th>
                完工日期
            </th>
            <th>
                負責人
            </th>   
            <th>
                    電話
                </th>
            <th>
                工程款
            </th>
            <th>
                備註
            </th>
            <th>
                工程確認
            </th>

            <th>
                編輯
            </th>
            <th>
                日報
            </th>
            @*<th>
                    刪除
                </th>*@

        </tr>


        @foreach (var item in Model)
        {
            ViewBag.check += 1;
            <tr id="tr_@item.fCode">
                <td>
                    @Html.DisplayFor(modelItem => item.fCode)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.fName)
                </td>

                <td>
                    @Html.DisplayFor(modelItem => item.fStage)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.fEST_Time)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.fSum_Time)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.fReal_Time)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.fChargeMan)
                </td>
                @*<td>
                        @Html.DisplayFor(modelItem => item.fComplete)
                    </td>*@

                <td>
                        @Html.DisplayFor(modelItem => item.fPhone)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.fPayment)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.fPS)

                </td>
                <td id="td_@item.fCode">
                    <input id="@item.fCode" type="checkbox" name="Check" value="檢核完畢" /><label>檢核完畢</label>
                    <button id="Myapply_@item.fCode" data-fPayment="@item.fPayment" data-fCode="@item.fCode" @*type="submit"*@ @*onclick="savetabletodb()"*@ class="Myapply btn btn-danger" disabled>申請經費</button>

                </td>
                <td>
                    @Html.ActionLink("編輯", "編輯專案", "工程管理", new { fId = item.fId }, new { @class = "btn btn-info" })
                </td>
                <td>
                    @Html.ActionLink("日報", "日報列表", "工程管理", new { txtcode = item.fCode }, new { @class = "btn btn-warning" })
                </td>
                @*<td>
                        @Html.ActionLink("刪除", "刪除專案", "工程管理", new { fId = item.fId }, new { @class = "btn btn-danger", onclick = "return confirm('確定要刪除嗎?')" })
                    </td>*@
            </tr>
        }
    </table>



    @section scripts{
        <script>
            $('.theli').hide();
        </script>
        <script>
            var flag = false;  //一開始沒有勾選
            $(":checkbox").click(function () {
                let x = this.id;    //透過變數x將checkbox的id存取
                 console.log(x);   
                flag = this.checked   //this.checked的狀態丟給flag
                console.log(flag)
                //let checked = $(`${x}`).prop("checked", flag)
                flag = !flag;    //透過! 將true改成false
                $(`#Myapply_${x}`).prop("disabled", flag) 
            })
           

            $(function () {
                $('.Myapply').click(function () {
                    $.ajax({
                        type: 'POST',
                        dataType:'json',
                        contentType: "application/json;charset=utf-8",
                        url: '/工程管理/PostdatatoDB',
                        data: JSON.stringify({
                            MyfCode: $(this).attr('data-fCode'),
                            MyfPayment:$(this).attr('data-fPayment')
                        }),
                        success: function (data) {
                            console.log(data)
                            alert("工程款項申請中，請確認工程已順利完工");
                        },
                        error: function (xhr, textStatus,errorThrown) {
                            alert(errorThrown);
                        }
                    });
                    //$(this).closest("tr").css("background", "#888888")
                    $(this).hide();
                });
            });
            function CheckingStatus() {
                $.getJSON("../工程管理/AJAX_Check", {}, function (datas) {
                    console.log(datas);
                    $.each(datas, function (order, value) {
                       console.log(order)
                        $.each(value, function (order2, value2) {
                            console.log(value2)
                            if (order == 0) {
                                $(`.tr_${value2}`).hide();

                            }
                            else if (order == 1) {
                                $(`.tr_${value2}`).css("backgroundColor", "pink")
                                console.log($(`.td_${value2}`).children()[2].innerText = "再次送審")
                            }
                            else if (order == 2) {
                                $(`.tr_${value2}`).css("backgroundColor", "lightgreen")
                                $(`.td_${value2}`).children().remove()
                            }
                            else if (order == 3) {
                                $(`.tr_${value2}`).css("backgroundColor", "skyblue")
                                $(`.td_${value2}`).children().remove()
                            }

                        })
                    })
                })
            }
            CheckingStatus()
        </script>
    }

</body>

</html>


